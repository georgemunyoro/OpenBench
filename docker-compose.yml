version: '3.9'

services:

  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-openbench}
      POSTGRES_USER: ${POSTGRES_USER:-openbench}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-openbench}"]
      interval: 5s
      timeout: 5s
      retries: 10

  server:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:?Set DJANGO_SECRET_KEY}
      DJANGO_DEBUG: ${DJANGO_DEBUG:-False}
      POSTGRES_DB: ${POSTGRES_DB:-openbench}
      POSTGRES_USER: ${POSTGRES_USER:-openbench}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST:-db}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-http://localhost:8000}
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-3}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-120}
    ports:
      - "${OPENBENCH_PORT:-8000}:8000"
    volumes:
      - media_data:/app/Media
      - static_data:/app/staticfiles
      - ./Config:/app/Config:ro
      - ./Engines:/app/Engines:ro
      - ./Books:/app/Books:ro

  client:
    build:
      context: .
      dockerfile: Dockerfile.client
    restart: unless-stopped
    depends_on:
      - server
    environment:
      OPENBENCH_SERVER: http://server:8000
      OPENBENCH_USERNAME: ${OPENBENCH_USERNAME:?Set OPENBENCH_USERNAME}
      OPENBENCH_PASSWORD: ${OPENBENCH_PASSWORD:?Set OPENBENCH_PASSWORD}
    command: ["-T", "${CLIENT_THREADS:-2}", "-N", "${CLIENT_SOCKETS:-1}"]

volumes:
  postgres_data:
  media_data:
  static_data:
